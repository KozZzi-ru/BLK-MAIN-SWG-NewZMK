# КОНФИГУРАЦИЯ ZMK ДЛЯ CHARYBDIS 4X6 WIRELESS MK2 (BLK) (ZEPHYR 4.1)

Экспериментальная прошивка ZMK для беспроводной сплит-клавиатуры **Charybdis 4x6 MK2 (black)** с трекболом **PMW3610** и продвинутой обработкой режимов трекбола.

**Внимание:** Это адаптация для **MK2 (черной клавиатуры)**. Для MK1 (белой) используйте другие бранчи с маркировкой WHT.

## Особенности этого бранча

✅ **Универсальный matrix transform**: Одинаковый keymap работает на МК1 и МК2
✅ **8-колоночная матрица**: Раздельные пины для основной матрицы и тамб кластера
✅ **Исправлен тамб кластер**: Все клавиши работают корректно на МК2

## Содержание

- [Особенности прошивки](#особенности-прошивки)
- [Аппаратная конфигурация](#аппаратная-конфигурация)
- [Решение проблемы тамб кластера](#решение-проблемы-тамб-кластера)
- [Структура репозитория](#структура-репозитория)
- [Режимы работы трекбола](#режимы-работы-трекбола)
- [Сборка прошивки](#сборка-прошивки)
- [Прошивка устройств](#прошивка-устройств)
- [История изменений](#история-изменений)

## Особенности прошивки

### ZMK и Zephyr
- **ZMK**: актуальная **main** ветка (rolling release)
- **Zephyr**: версия **4.1**
- Переход с `nice_nano_v2` на `nice_nano` в связи с изменениями в Zephyr 4.1

### Ключевые возможности
- **Два независимых режима скролла** (быстрый и медленный) на разных слоях
- **Раздельная скорость вертикального и горизонтального скролла**
- **Автоматическая генерация визуализации раскладки** в формате SVG при каждой сборке
- **Визуализация включается в артефакт** вместе с файлами прошивки
- **Оптимизированный Bluetooth** буфер для стабильной связи
- **Универсальный keymap** для МК1 и МК2 (keymap не требует изменений между клавиатурами)

## Аппаратная конфигурация

### Компоненты
- **Плата контроллера**: nice_nano (ProMicro nRF52840)
- **Раскладка**: Charybdis 4x6 (сплит-клавиатура)
- **Трекбол**: PMW3610 (драйвер pmw3610-alt от badjeff, ревизия **zmk-0.4**)
- **CPI трекбола**: 1000 (текущая настройка)
- **Интерфейс трекбола**: SPI
- **Клавиатура**: MK2 (черная)

### Пины подключения

#### Клавишная матрица (обе половины)

**Занятые пины:**

Строки (rows, общие):
- **P0.31** - Row 0
- **P1.15** - Row 1
- **P0.24** - Row 2
- **P0.22** - Row 3
- **P1.6** - Row 4

Колонки (columns, каждая половина) - **MK2 (BLK) - 8 колонок**:
- **P0.2** - Col 0 (общая)
- **P0.29** - Col 1 (общая)
- **P0.9** - Col 2 (общая)
- **P1.0** - Col 3 (МК1 пин - для тамб кластера)
- **P0.11** - Col 4 (МК1 пин - для тамб кластера)
- **P0.10** - Col 5 ⚠️ **МК2 пин - для основной матрицы**
- **P1.13** - Col 6 ⚠️ **МК2 пин - для основной матрицы**
- **P1.4** - Col 7 (общая)

## Решение проблемы тамб кластера

### Проблема
У МК2 **разная распайка** для основной матрицы и тамб кластера:
- **Row 0-3** (основные клавиши): используют **новые пины МК2** (P0.10, P1.13)
- **Row 4** (тамб кластер): используют **старые пины МК1** (P1.0, P0.11)

### Решение
Используем **8-колоночную матрицу** с универсальным matrix transform:
- Col 0-2, 7: общие пины (одинаковые для МК1 и МК2)
- Col 3-4: старые пины МК1 (для тамб кластера)
- Col 5-6: новые пины МК2 (для основной матрицы)

**Matrix transform**:
- Row 0-3 используют col 0,1,2,5,6,7 (пропускают col 3-4)
- Row 4 использует col 3,4,1,7,2 (использует col 3-4)

**Результат**: Keymap остается идентичным для МК1 и МК2! ✅

#### Трекбол PMW3610 (только правая половина)

**Занятые пины:**
- **P0.8** - SPI SCK
- **P0.17** - SPI MOSI/MISO
- **P0.20** - SPI CS
- **P0.6** - IRQ

**Итого занято на правой половине:** 17 пинов (5 rows + 8 cols + 4 trackball)

**Итого занято на левой половине:** 13 пинов (5 rows + 8 cols)

#### Свободные пины

**На правой половине MK2:**
- P0.30, P1.11, P0.3, P0.28

**На левой половине MK2:**
- P0.6, P0.8, P0.17, P0.20, P0.30, P1.11, P0.3, P0.28

## Структура репозитория

```text
WHT-MAIN-SWG-based-on-ch-4-6-wl/
├── .github/workflows/
│   ├── main.yml                              # Основной workflow сборки (BLK)
│   └── draw_keymaps.yaml                     # Генерация SVG визуализации
├── boards/shields/charybdis/
│   ├── charybdis.dtsi                        # Универсальный matrix transform (8 колонок)
│   ├── charybdis_layers.h                    # Определения слоёв
│   ├── charybdis_trackball_processors.dtsi   # Конфигурация input processors
│   ├── charybdis_left.overlay                # 8-колоночная конфигурация левой половины (MK2)
│   ├── charybdis_right.overlay               # 8-колоночная конфигурация правой половины (MK2)
│   └── ...
├── config/
│   ├── charybdis.keymap                      # Раскладка клавиатуры (универсальная)
│   ├── charybdis.conf                        # Глобальная конфигурация ZMK
│   └── west.yml                              # Манифест зависимостей
├── keymap-drawer/
│   ├── charybdis.svg                         # Автоматически сгенерированная визуализация
│   └── charybdis.yaml                        # YAML представление раскладки
└── README.md                                 # Этот файл
```

## Режимы работы трекбола

⚠️ **Порядок обработки критически важен!** Более специфичные режимы проверяются первыми.

### 1. Снайперский режим (SNIPE layer - слой 3)
- **Масштабирование**: 1:3 (замедление в 3 раза)
- **Назначение**: Точные операции, прицеливание

### 2. Режим мыши (AUTO_MOUSE layer - слой 2)
- **Масштабирование**: 1:1 (нативная скорость)
- **Назначение**: Стандартное перемещение курсора

### 3. Медленный скролл (NUM_AND_FUN layer - слой 1)
- **Масштабирование**: 1:16 (экстремально быстрое преобразование)
- **Раздельные оси**: вертикальный 1:8, горизонтальный 1:16 (горизонталь в 2× медленнее)

### 4. Быстрый скролл (QWERTY layer - слой 0)
- **Масштабирование**: 1:10 (экстремально быстрое преобразование)
- **Раздельные оси**: вертикальный 1:4, горизонтальный 1:8 (горизонталь в 2× медленнее)

## Сборка прошивки

### GitHub Actions (автоматически)

При каждом push в репозиторий автоматически запускается процесс сборки:

1. **Генерация визуализации раскладки**: Создаётся SVG-изображение из `config/charybdis.keymap`
2. **Сборка прошивки**: Компилируются файлы `.uf2` для обеих половин клавиатуры
3. **Создание пакета**: Формируется артефакт `firmware_BLK_SVG`
4. **Скачивание**: Actions → последний build → артефакт `firmware_BLK_SVG`

## Прошивка устройств

### Процесс прошивки

1. Дважды нажми кнопку reset на плате (быстро, два раза подряд)
2. Плата появится как USB-накопитель `NICENANO`
3. Скопируй соответствующий `.uf2` файл на накопитель
4. Плата автоматически перезагрузится

### Когда прошивать какие файлы

| Что изменил | Левая | Правая | Reset |
|-------------|-------|--------|-------|
| Настройки трекбола (CPI, скорость) | ❌ | ✅ | ❌ |
| Раскладка клавиш (keymap) | ✅ | ✅ | ❌ |
| Комбинации клавиш (combos) | ✅ | ✅ | ❌ |
| Обновление ZMK/Zephyr | ✅ | ✅ | ✅ |
| Проблемы с Bluetooth | ✅ | ✅ | ✅ |
| Первая прошивка | ✅ | ✅ | ✅ |
| Пины/аппаратная конфигурация | ✅ | ✅ | ✅ |
| Глобальные настройки (charybdis.conf) | ✅ | ✅ | ❌ |

## История изменений

### 08.02.2026 - Исправлен тамб кластер МК2 с универсальным matrix transform
- Создан бранч `BLK-fix-thumb-cluster`
- Реализована 8-колоночная матрица с универсальным matrix transform
- Col 0-2,7: общие пины (одинаковые для МК1 и МК2)
- Col 3-4: старые пины МК1 (для тамб кластера МК2)
- Col 5-6: новые пины МК2 (для основной матрицы МК2)
- Row 0-3: используют col 0,1,2,5,6,7 (основная матрица)
- Row 4: используют col 3,4,1,7,2 (тамб кластер)
- **Keymap теперь универсальный** - один и тот же файл работает на МК1 и МК2
- Исправлена проблема с неработающими клавишами в тамб кластере

### 08.02.2026 - Адаптация для МК2 (BLK) с правильной маркировкой
- Создан бранч `BLK-MAIN-SWG-NewZMK-correct`
- Изменены GPIO пины col-gpios для 4-й и 5-й колонок под распайку МК2 (черная)
- Левая/правая половины: Col 3: gpio1 0 → gpio0 10, Col 4: gpio0 11 → gpio1 13
- Изменена маркировка артефактов: firmware_WHT → firmware_BLK
- ⚠️ **Проблема**: тамб кластер не работал корректно (исправлено в следующем бранче)

### 05.02.2026 - Экспериментальные экстремальные делители скролла
- Создан бранч `READY_extreme-scroll-dividers`
- Медленный скролл: xy=16, wheel=8, hwheel=16
- Быстрый скролл: xy=10, wheel=4, hwheel=8
- Горизонтальный скролл в 2× медленнее вертикального

## Полезные ссылки

- [ZMK Firmware](https://github.com/zmkfirmware/zmk) - основная прошивка ZMK
- [PMW3610 Driver by badjeff](https://github.com/badjeff/zmk-pmw3610-driver) - драйвер трекбола PMW3610
- [ZMK Input Processors](https://zmk.dev/docs/keymaps/input-processors/scaler) - документация по обработке ввода

## Предупреждение

⚠️ **Экспериментальная ветка!** Main ветка ZMK может содержать нестабильные изменения. Для production рекомендуется использовать фиксированные версии ZMK.
