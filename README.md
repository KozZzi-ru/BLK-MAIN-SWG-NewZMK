# КОНФИГУРАЦИЯ ZMK ДЛЯ CHARYBDIS 4X6 WIRELESS MK2 (BLK) (ZEPHYR 4.1)

Экспериментальная прошивка ZMK для беспроводной сплит-клавиатуры **Charybdis 4x6 MK2 (black)** с трекболом **PMW3610** и продвинутой обработкой режимов трекбола.

**Внимание:** Это адаптация для **MK2 (черной клавиатуры)**. Для MK1 (белой) используйте другие бранчи с маркировкой WHT.

## Содержание

- [Особенности прошивки](#особенности-прошивки)
- [Аппаратная конфигурация](#аппаратная-конфигурация)
- [Структура репозитория](#структура-репозитория)
- [Режимы работы трекбола](#режимы-работы-трекбола)
- [West.yml конфигурация](#westyml-конфигурация)
- [GitHub Actions конфигурация](#github-actions-конфигурация)
- [Визуализация раскладки](#визуализация-раскладки)
- [Настройка чувствительности трекбола](#настройка-чувствительности-трекбола)
- [Сборка прошивки](#сборка-прошивки)
- [Прошивка устройств](#прошивка-устройств)
- [История изменений](#история-изменений)

## Особенности прошивки

### ZMK и Zephyr
- **ZMK**: актуальная **main** ветка (rolling release)
- **Zephyr**: версия **4.1**
- Переход с `nice_nano_v2` на `nice_nano` в связи с изменениями в Zephyr 4.1

### Ключевые возможности
- **Два независимых режима скролла** (быстрый и медленный) на разных слоях
- **Раздельная скорость вертикального и горизонтального скролла**
- **Автоматическая генерация визуализации раскладки** в формате SVG при каждой сборке
- **Визуализация включается в артефакт** вместе с файлами прошивки
- **Оптимизированный Bluetooth** буфер для стабильной связи

## Аппаратная конфигурация

### Компоненты
- **Плата контроллера**: nice_nano (ProMicro nRF52840)
- **Раскладка**: Charybdis 4x6 (сплит-клавиатура)
- **Трекбол**: PMW3610 (драйвер pmw3610-alt от badjeff, ревизия **zmk-0.4**)
- **CPI трекбола**: 1000 (текущая настройка)
- **Интерфейс трекбола**: SPI
- **Клавиатура**: MK2 (черная)

### Пины подключения

#### Клавишная матрица (обе половины)

**Занятые пины:**

Строки (rows, общие):
- **P0.31** - Row 0
- **P1.15** - Row 1
- **P0.24** - Row 2
- **P0.22** - Row 3
- **P1.6** - Row 4

Колонки (columns, каждая половина) - **MK2 (BLK)**:
- **P0.2** - Col 0
- **P0.29** - Col 1
- **P0.9** - Col 2
- **P0.10** - Col 3 ⚠️ **отличается от MK1**
- **P1.13** - Col 4 ⚠️ **отличается от MK1**
- **P1.4** - Col 5

**Отличия от MK1 (WHT):**
- MK1: Col 3 = P1.0, Col 4 = P0.11
- MK2: Col 3 = P0.10, Col 4 = P1.13

#### Трекбол PMW3610 (только правая половина)

**Занятые пины:**
- **P0.8** - SPI SCK
- **P0.17** - SPI MOSI/MISO
- **P0.20** - SPI CS
- **P0.6** - IRQ

**Итого занято на правой половине:** 15 пинов (5 rows + 6 cols + 4 trackball)

**Итого занято на левой половине:** 11 пинов (5 rows + 6 cols)

#### Свободные пины

**На правой половине MK2:**
- P1.0, P0.11, P0.30, P1.11, P0.3, P0.28

**На левой половине MK2:**
- P0.6, P0.8, P0.17, P0.20, P1.0, P0.11, P0.30, P1.11, P0.3, P0.28

## Структура репозитория

```text
WHT-MAIN-SWG-based-on-ch-4-6-wl/
├── .github/workflows/
│   ├── main.yml                              # Основной workflow сборки (BLK)
│   └── draw_keymaps.yaml                     # Генерация SVG визуализации
├── boards/shields/charybdis/
│   ├── charybdis_layers.h                    # Определения слоёв
│   ├── charybdis_trackball_processors.dtsi   # Конфигурация input processors
│   ├── charybdis_left.overlay                # Конфигурация левой половины (MK2)
│   ├── charybdis_right.overlay               # Конфигурация правой половины с трекболом (MK2)
│   └── ...
├── config/
│   ├── charybdis.keymap                      # Раскладка клавиатуры
│   ├── charybdis.conf                        # Глобальная конфигурация ZMK
│   └── west.yml                              # Манифест зависимостей
├── keymap-drawer/
│   ├── charybdis.svg                         # Автоматически сгенерированная визуализация
│   └── charybdis.yaml                        # YAML представление раскладки
└── README.md                                 # Этот файл
```

### Ключевые файлы

- **`charybdis_layers.h`**: Определения слоёв (QWERTY, NUM_AND_FUN, AUTO_MOUSE, SNIPE)
- **`charybdis_trackball_processors.dtsi`**: Обработка ввода трекбола с правильным порядком процессоров
- **`charybdis_right.overlay`**: Аппаратная конфигурация правой половины (GPIO, SPI, трекбол)
- **`config/west.yml`**: Зависимости прошивки (ZMK, драйверы)

## Режимы работы трекбола

⚠️ **Порядок обработки критически важен!** Более специфичные режимы проверяются первыми.

### 1. Снайперский режим (SNIPE layer - слой 3)
- **Масштабирование**: 1:3 (замедление в 3 раза)
- **Назначение**: Точные операции, прицеливание
- **Применение**: Работа с мелкими элементами интерфейса

### 2. Режим мыши (AUTO_MOUSE layer - слой 2)
- **Масштабирование**: 1:1 (нативная скорость)
- **Назначение**: Стандартное перемещение курсора
- **Применение**: Обычная навигация с нативной скоростью сенсора

### 3. Медленный скролл (NUM_AND_FUN layer - слой 1)
- **Масштабирование**: 1:16 (экстремально быстрое преобразование)
- **Раздельные оси**: вертикальный 1:8, горизонтальный 1:16 (горизонталь в 2× медленнее)
- **Инверсия**: Y-ось инвертирована
- **Назначение**: Экспериментальный режим с многоуровневым масштабированием
- **Применение**: Тестирование влияния дублирующих делителей

### 4. Быстрый скролл (QWERTY layer - слой 0)
- **Масштабирование**: 1:10 (экстремально быстрое преобразование)
- **Раздельные оси**: вертикальный 1:4, горизонтальный 1:8 (горизонталь в 2× медленнее)
- **Инверсия**: Y-ось инвертирована
- **Назначение**: Экспериментальный режим с многоуровневым масштабированием
- **Применение**: Тестирование влияния дублирующих делителей

## West.yml конфигурация

Файл `config/west.yml` определяет зависимости прошивки ZMK и внешние модули.

### Удалённые репозитории

```yaml
remotes:
  - name: zmkfirmware
    url-base: https://github.com/zmkfirmware
  - name: badjeff
    url-base: https://github.com/badjeff
```

- **zmkfirmware**: Основная прошивка ZMK
- **badjeff**: Драйвер трекбола PMW3610

### Зависимости

- **zmk**: Основная прошивка ZMK (ветка `main`)
- **zmk-pmw3610-driver**: Драйвер трекбола PMW3610 (ревизия `zmk-0.4`)
  - Источник: [badjeff/zmk-pmw3610-driver](https://github.com/badjeff/zmk-pmw3610-driver)
  - Поддержка Zephyr 4.1
  - Полная конфигурация input processors

## GitHub Actions конфигурация

Файл `.github/workflows/main.yml` определяет автоматическую сборку прошивки при каждом push.

### Процесс сборки

```yaml
jobs:
  keymap_images:
    permissions:
      contents: write
    uses: ./.github/workflows/draw_keymaps.yaml
    with:
      destination: 'both'
      artifact_name: 'keymap_raw_files'
    
  build:
    needs: keymap_images
    uses: zmkfirmware/zmk/.github/workflows/build-user-config.yml@main
    with:
      archive_name: firmware_BLK
      
  package_with_keymap:
    needs: [build, keymap_images]
    runs-on: ubuntu-latest
    # Создание финального артефакта firmware_BLK_SVG
```

### Этапы

1. **keymap_images**: Генерация SVG-визуализации раскладки из `config/charybdis.keymap`
2. **build**: Сборка файлов `.uf2` для обеих половин клавиатуры
3. **package_with_keymap**: Объединение прошивки и визуализации в один артефакт

### Результат

Артефакт `firmware_BLK_SVG` содержит:
- `charybdis_left-nice_nano-zmk.uf2`
- `charybdis_right-nice_nano-zmk.uf2`
- `settings_reset-nice_nano-zmk.uf2`
- `charybdis.svg` - визуализация раскладки

## Визуализация раскладки

Визуализация автоматически генерируется из файла `config/charybdis.keymap` с помощью [Keymap Drawer](https://github.com/caksoylar/keymap-drawer) при каждой сборке.

## Настройка чувствительности трекбола

### Аппаратная чувствительность (CPI)

Настраивается в файле `charybdis_right.overlay`:

```dts
trackball: trackball@0 {
    compatible = "pixart,pmw3610-alt";
    cpi = <1000>;  // Текущая настройка, измени это значение
};
```

**Рекомендуемые значения CPI:**
- `400` - Низкая чувствительность
- `800` - Средняя чувствительность
- `1000` - Высокая чувствительность (текущая настройка)
- `1200` - Очень высокая чувствительность
- `1600` - Экстремально высокая чувствительность

### Программное масштабирование

Настраивается в `charybdis_trackball_processors.dtsi`:

```dts
// Обычное движение курсора
move {
    layers = <AUTO_MOUSE>;
    input-processors = <&zip_xy_scaler 1 1>;  // Нативная скорость
};

// Снайперский режим
snipe {
    layers = <SNIPE>;
    input-processors = <&zip_xy_scaler 1 3>;  // Скорость × 1/3 (замедление в 3 раза)
};

// Медленный скролл (экстремальные делители)
scroll_slow {
    layers = <NUM_AND_FUN>;
    input-processors = <&zip_xy_scaler 1 16>,   // Быстрое преобразование в скролл
                       <&zip_wheel_scaler 1 8>,    // Вертикальный с торможением
                       <&zip_hwheel_scaler 1 16>;  // Горизонтальный в 2 раза медленнее
};

// Быстрый скролл (экстремальные делители)
scroll {
    layers = <QWERTY>;
    input-processors = <&zip_xy_scaler 1 10>,   // Быстрое преобразование в скролл
                       <&zip_wheel_scaler 1 4>,    // Вертикальный с торможением
                       <&zip_hwheel_scaler 1 8>;   // Горизонтальный в 2 раза медленнее
};
```

**Формула**: `выход = (вход × множитель) / делитель`

⚠️ **Важно**: Используй значения ≤ 16 для множителя и делителя во избежание переполнения.

## Сборка прошивки

### GitHub Actions (автоматически)

При каждом push в репозиторий автоматически запускается процесс сборки:

1. **Генерация визуализации раскладки**: Workflow `draw_keymaps.yaml` автоматически создаёт SVG-изображение твоей раскладки клавиатуры из файла `config/charybdis.keymap`

2. **Сборка прошивки**: Компилируются файлы `.uf2` для обеих половин клавиатуры

3. **Создание пакета**: Формируется финальный артефакт `firmware_BLK_SVG`, содержащий:
   - `charybdis_left-nice_nano-zmk.uf2` - прошивка левой половины
   - `charybdis_right-nice_nano-zmk.uf2` - прошивка правой половины
   - `settings_reset-nice_nano-zmk.uf2` - сброс настроек
   - `charybdis.svg` - визуализация раскладки клавиатуры

4. **Скачивание**: Открой вкладку Actions в репозитории → выбери последний успешный build → скачай артефакт `firmware_BLK_SVG`

Визуализация раскладки также автоматически коммитится в папку `keymap-drawer/` в репозитории.

## Прошивка устройств

### Процесс прошивки

1. Дважды нажми кнопку reset на плате (быстро, два раза подряд)
2. Плата появится как USB-накопитель с именем `NICENANO`
3. Скопируй соответствующий `.uf2` файл на этот накопитель
4. Плата автоматически перезагрузится с новой прошивкой

### Когда прошивать какие файлы

| Что изменил | Левая | Правая | Reset |
|-------------|-------|--------|-------|
| Настройки трекбола (CPI, скорость) | ❌ | ✅ | ❌ |
| Раскладка клавиш (keymap) | ✅ | ✅ | ❌ |
| Комбинации клавиш (combos) | ✅ | ✅ | ❌ |
| Обновление ZMK/Zephyr | ✅ | ✅ | ✅ |
| Проблемы с Bluetooth | ✅ | ✅ | ✅ |
| Первая прошивка | ✅ | ✅ | ✅ |
| Пины/аппаратная конфигурация трекбола | ❌ | ✅ | ❌ |
| Глобальные настройки (charybdis.conf) | ✅ | ✅ | ❌ |

## История изменений

### 08.02.2026 - Адаптация для МК2 (BLK) с правильной маркировкой
- Создан бранч `BLK-MAIN-SWG-NewZMK-correct`
- Изменены GPIO пины col-gpios для 4-й и 5-й колонок под распайку МК2 (черная)
- Левая/правая половины: Col 3: gpio1 0 → gpio0 10, Col 4: gpio0 11 → gpio1 13
- Изменена маркировка артефактов: firmware_WHT → firmware_BLK
- Изменена маркировка артефактов: firmware_WHT_SVG → firmware_BLK_SVG
- Обновлен README с указанием что это прошивка для MK2 (BLK)
- Настройки трекбола от МК1: драйвер pmw3610-alt с swap-xy, invert-x/y, force-awake

### 05.02.2026 - Экспериментальные экстремальные делители скролла
- Создан новый бранч `READY_extreme-scroll-dividers`
- Медленный скролл: xy=16, wheel=8, hwheel=16 (двойное деление: сначала XY, потом оси)
- Быстрый скролл: xy=10, wheel=4, hwheel=8 (двойное деление: сначала XY, потом оси)
- Горизонтальный скролл в 2× медленнее вертикального (было 3-4×)
- ЭКСПЕРИМЕНТАЛЬНАЯ конфигурация для тестирования многоуровневого масштабирования

## Полезные ссылки

- [ZMK Firmware](https://github.com/zmkfirmware/zmk) - основная прошивка ZMK
- [PMW3610 Driver by badjeff](https://github.com/badjeff/zmk-pmw3610-driver) - драйвер трекбола PMW3610
- [ZMK Input Processors](https://zmk.dev/docs/keymaps/input-processors/scaler) - документация по обработке ввода
- [choovick/zmk-config-charybdis](https://github.com/choovick/zmk-config-charybdis) - референсная конфигурация Charybdis с донглом и OLED

## Предупреждение

⚠️ **Экспериментальная ветка!** Main ветка ZMK может содержать нестабильные изменения. Для production рекомендуется использовать фиксированные версии ZMK.
